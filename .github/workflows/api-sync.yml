name: Sync API Definition to xq-apis

on:
  push:
    branches:
      - main
    paths:
      - 'api/write-service-api.yaml'
  workflow_dispatch:


jobs:
  check-version-change:
    runs-on: ubuntu-latest
    outputs:
      version_changed: ${{ steps.check.outputs.version_changed }}
      current_version: ${{ steps.check.outputs.current_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if version changed
        id: check
        run: |
          # Get current version
          current_version=$(grep -m 1 "version:" api/write-service-api.yaml | sed 's/.*version: *//' | tr -d ' ')
          echo "current_version=$current_version" >> $GITHUB_OUTPUT

          # Get previous version (if file existed in previous commit)
          if git show HEAD~1:api/write-service-api.yaml &>/dev/null; then
            previous_version=$(git show HEAD~1:api/write-service-api.yaml | grep -m 1 "version:" | sed 's/.*version: *//' | tr -d ' ')
            echo "Previous version: $previous_version"
            echo "Current version: $current_version"

            if [ "$current_version" != "$previous_version" ]; then
              echo "version_changed=true" >> $GITHUB_OUTPUT
              echo "Version changed from $previous_version to $current_version"
            else
              echo "version_changed=false" >> $GITHUB_OUTPUT
              echo "Version unchanged"
            fi
          else
            # First time file is added
            echo "version_changed=true" >> $GITHUB_OUTPUT
            echo "New API definition file added with version $current_version"
          fi

  create-pr:
    needs: check-version-change
    if: needs.check-version-change.outputs.version_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout write-service repository
        uses: actions/checkout@v4
        with:
          path: write-service

      - name: Checkout xq-apis repository
        uses: actions/checkout@v4
        with:
          repository: chauhaidang/xq-apis
          token: ${{ secrets.GH_PAT }}
          path: xq-apis

      - name: Configure Git
        run: |
          cd xq-apis
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create branch and copy API definition
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          cd xq-apis

          # Create a new branch
          branch_name="api-update/write-service-v${{ needs.check-version-change.outputs.current_version }}"
          git checkout -b "$branch_name"

          # Create directory if it doesn't exist
          mkdir -p api/write-service

          # Copy the API definition file
          cp ../write-service/api/write-service-api.yaml api/write-service/

          # Add and commit changes
          git add api/write-service/write-service-api.yaml
          git commit -m "Update write-service API definition to v${{ needs.check-version-change.outputs.current_version }}"

          # Push the branch
          git push origin "$branch_name"

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          cd xq-apis

          # Create PR using GitHub CLI
          gh pr create \
            --title "Update write-service API definition to v${{ needs.check-version-change.outputs.current_version }}" \
            --body "$(cat <<'EOF'
          ## Summary
          This PR updates the write-service API definition file to version ${{ needs.check-version-change.outputs.current_version }}.

          ## Changes
          - Updated `api/write-service/write-service-api.yaml` from the write-service repository
          - API version: ${{ needs.check-version-change.outputs.current_version }}

          ## Source
          - Repository: ${{ github.repository }}
          - Commit: ${{ github.sha }}
          - Triggered by: ${{ github.event.head_commit.message }}

          ---
          *This PR was automatically generated by GitHub Actions*
          EOF
          )" \
            --base main \
            --head "api-update/write-service-v${{ needs.check-version-change.outputs.current_version }}"